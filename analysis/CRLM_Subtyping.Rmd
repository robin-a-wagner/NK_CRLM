---
title: "CRLM_Subtyping"
author: "Robin Wagner (UoM Laptop)"
date: "2023-08-23"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

## Introduction

In this code I will use nearest template prediction to classify the consensus molecular subtype (CMS) and intrinsic CMS of each CRLM sample using the CMScaller package. 

```{r message=FALSE, warning=FALSE}

library(dplyr)
library(CMScaller)
library(ggplot2)
library(RColorBrewer)
library(ggpubr)

```

### Prepare data

Read in and prepare the raw counts data for the 58 samples. 

```{r}

expr <- readRDS("data/Hollande_DGEList_Tum_Raw.RDS"); dim(expr)

```

Remove duplicated sample. 

```{r} 

expr$samples <- expr$samples[-12,]
expr$counts <- expr$counts[,-12]
dim(expr$samples); dim(expr$counts)
all(colnames(expr$counts) == rownames(expr$samples))

```

Filter out primary tumours as these are irrelevant to our analysis. 

```{r}

expr$samples <- expr$samples %>% filter(!Tissue == "CoT"); summary(expr$samples$Tissue)
expr$counts <- expr$counts[,rownames(expr$samples)]; dim(expr$counts)

```

Filter out lowly-expressed genes. 

```{r}

keep <- filterByExpr(expr$counts)
expr_filt <- expr[keep, ]; dim(expr_filt)

```

### Perform subtyping 

Perform CMS classification using inbuilt template. 

```{r message=FALSE}

CMS <- CMScaller(emat = expr_filt$counts, RNAseq=TRUE, FDR=0.05); head(CMS)
summary(CMS$prediction)

```

Create templates for iCMS. Here genes up in iCMS2 and down iCMS3 are designated iCMS2 genes. The reverse is true for iCMS3. 

```{r}

iCMS_template <- read.csv("data/iCMS_template.csv"); head(iCMS_template)
iCMS_template$probe <- fromTo(key = iCMS_template$symbol, id.in = "symbol", id.out = "entrez")

```

Classify according to iCMS. 

```{r message=FALSE}

iCMS <- CMScaller(expr_filt$counts, templates = iCMS_template, RNAseq = T, FDR = 0.05); head(iCMS)
summary(iCMS$prediction)

```

Load NK score data. 

```{r}

nk_score <- read.csv("output/20230823_Shembrey_NK_Score_Hollande_CRLM.csv", row.names = 1); head(nk_score)

```

Visualise the association between subtypes and NK score. 

```{r}

plot_data <- data.frame(sample = colnames(expr_filt$counts),
                        CMS = CMS$prediction,
                        iCMS = iCMS$prediction,
                        nk_score = nk_score$score); head(plot_data)

ggplot(plot_data, aes(x = CMS, y = nk_score, fill = CMS)) + 
  geom_boxplot() + 
  geom_point(position = position_dodge(0.9), color = "gray20") + 
  stat_compare_means(method = "anova") +
  theme_bw() +
  theme(text = element_text(size = 15),
        legend.position = "none") +
  scale_fill_manual(values = brewer.pal(8, "Paired")) +
  labs(x = "") +
  ggtitle("CMS")

ggplot(plot_data, aes(x = iCMS, y = nk_score, fill = iCMS)) + 
  geom_boxplot() + 
  geom_point(position = position_dodge(0.9), color = "gray20") + 
  stat_compare_means(method = "t.test", comparisons = list(c("iCMS2", "iCMS3"))) +
  theme_bw()  +
  theme(text = element_text(size = 15),
        legend.position = "none") +
  scale_fill_manual(values = brewer.pal(3, "Paired")[2:3]) +
  labs(x = "") +
  ggtitle("iCMS")

```
