---
title: "NK_Scoring"
author: "Robin Wagner (UoM Laptop)"
date: "2023-08-23"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

## Introduction

In this code I will load and process the raw counts data generated from CRLM tissue and perform single-sample scoring against a CRC-specific NK signature using singscore. 

### Setup 

```{r message=FALSE, warning=FALSE}
 
library(dplyr) 
library(edgeR) 
library(singscore)
library(ggplot2)
library(RColorBrewer)
library(ggpubr)

```

### Prepare data

Read in and prepare the raw counts data for the 58 samples. Data stored in limma DGE List object. 

```{r}

expr <- readRDS("data/Hollande_DGEList_Tum_Raw.RDS"); dim(expr)

```

Remove duplicated sample. 

```{r} 

expr$samples <- expr$samples[-12,]
expr$counts <- expr$counts[,-12]
dim(expr$samples); dim(expr$counts)
all(colnames(expr$counts) == rownames(expr$samples))

```

Filter out primary tumours as these are irrelevant to our analysis. 

```{r}

expr$samples <- expr$samples %>% filter(!Tissue == "CoT"); summary (expr$samples$Tissue)
expr$counts <- expr$counts[,rownames(expr$samples)]; dim(expr$counts)

```

Load the NK signature now so that we preserve these genes upon filtering. 

```{r}

nk_sig <- read.csv("data/20230822_Shembrey_NK_Signature.csv"); head(nk_sig)

```

Filter out lowly-expressed genes but preserve signature genes for scoring. 

```{r}

keep <- filterByExpr(expr$counts)
keep2 <- rownames(expr$counts) %in% nk_sig$ENTREZID
expr_filt <- expr[keep | keep2, ]; dim(expr_filt)

```

Visualise the effects of filtration. 

```{r}

lcpm <- data.frame(edgeR::cpm(expr, log = T))
lcpm_filt <- data.frame(edgeR::cpm(expr_filt, log = T))

lcpm <- lcpm %>%
  mutate(gene = rownames(lcpm)) %>%
  tidyr::gather(key = sample, value = expr, -gene); head(lcpm)

ggplot(lcpm, aes(x = expr, color = sample)) + 
  geom_density() +
  guides(color = "none") +
  theme_bw() +
  theme(text = element_text(size = 12))
 
lcpm_filt <- lcpm_filt %>%
  mutate(gene = rownames(lcpm_filt)) %>%
  tidyr::gather(key = sample, value = expr, -gene); head(lcpm_filt)

lcpm_plot <- ggplot(lcpm, aes(x = expr, color = sample)) + 
  geom_density() +
  guides(color = "none") +
  theme_bw() +
  theme(text = element_text(size = 12)) +
  ggtitle("Pre-Filtration")

lcpm_filt_plot <- ggplot(lcpm_filt, aes(x = expr, color = sample)) + 
  geom_density() +
  guides(color = "none") +
  theme_bw() +
  theme(text = element_text(size = 12)) +
  ggtitle("Post-Filtration")

ggarrange(lcpm_plot, lcpm_filt_plot)

````

Normalise for library size. 

```{r}

expr_norm <- calcNormFactors(expr_filt, method = "TMM")

```

### Perform NK scoring

Normalise read counts for gene length, in order to perform sample scoring with singscore. 

```{r}

expr_rpkm <- edgeR::rpkm(expr_norm, gene.length = expr_norm$genes$Length, log = T)

```

Rank genes. 

```{r}

expr_ranked <- rankGenes(expr_rpkm)

```

Score samples using NK signature. 

```{r}

score <- simpleScore(expr_ranked, nk_sig$ENTREZID)[,1]; head(score)

nk_score <- data.frame(sample = colnames(expr_rpkm),
                       score = score, 
                       quartile = ntile(score, 4)) %>%
  mutate(designation = ifelse(quartile == 1, "low",
                              ifelse(quartile == 4, "high", "intermediate"))); head(nk_score)

write.csv(nk_score, "output/20230823_Shembrey_NK_Score_Hollande_CRLM.csv")

```

Visualise the scores. 

```{r, fig.height=10, fig.width=6}

ggplot(nk_score, aes(x = reorder(sample, score), y = score, fill = designation)) +
  geom_bar(stat = "identity") +
  coord_flip() + 
  theme_bw() + 
  scale_fill_manual(values = brewer.pal(3, "Paired")) + 
  labs(x = "") +
  theme(text = element_text(size = 15))

```
